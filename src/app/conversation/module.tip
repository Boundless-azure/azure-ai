模块名称：app/conversation（对话模块）

目标
- 提供标准与流式（SSE 风格）AI 对话接口：
  - POST /conversation/chat（支持流式，返回 data: <json>\n\n 分片）
  - POST /conversation/sessions（创建新会话）
 - GET  /conversation/sessions/:sessionId/history（会话历史）
 - GET  /conversation/checkpoints/:threadId（检查点列表）
  - GET  /conversation/checkpoints/:threadId/:checkpointId（检查点详情/历史片段）
  - 对话组接口：
    - GET  /conversation/groups（分页：page/pageSize；每组附带 latestMessage；不支持日期筛选）
    - GET  /conversation/groups/:groupId（组详情）
    - POST /conversation/groups（创建组，入参：date 或 dayGroupId）
    - PUT  /conversation/groups/:groupId（更新标题/active/chatClientId）
    - DELETE /conversation/groups/:groupId（软删除）
    - GET  /conversation/groups/:groupId/summaries（根据组ID获取阶段性总结）
    - GET  /conversation/groups/:groupId/history（根据组ID获取最近窗口历史，支持 includeSystem/limit）
  - 线程消息接口：
    - POST /conversation/threads/:threadId/messages（在线程内发送用户消息，自动复用或创建会话并绑定到该组）

文件结构
- controllers/conversation.controller.ts：对外 REST 接口（标准/流式）
- services/conversation.service.ts：对话业务逻辑、AI 调用、function-call 执行
- types/conversation.types.ts：类型声明与运行时守卫（type guards）
- module.tip：模块说明与规范

类型与守卫（types/conversation.types.ts）
- 类型：
  - ChatRequest / ChatResponse / StreamChunk
  - CreateSessionRequest / CreateSessionResponse
  - GetHistoryRequest / GetHistoryResponse
  - MessageMetadata / FunctionCall / AIModelResponseWithFunctionCalls
- 守卫：
  - isObject / isStringArray
  - isOrchestratorParams（phase/modelId/input 校验；generate 阶段要求 plan）
  - isMysqlSelectArgs（sql:string, limit:number, params?:array）
  - isKeywordWindowArgs（keywords:string[], limit:number, includeSystem?:boolean, matchMode?:'any'|'all'）

流式传输规范（SSE 风格）
- 响应头：
  - Content-Type: text/event-stream（建议；当前实现为 text/stream 也可解析）
  - Cache-Control: no-cache
  - Connection: keep-alive
  - Access-Control-Allow-Origin: *
- 数据格式：按行输出 "data: {json}\n\n"
  - 正常分片：{ type: 'content', content, sessionId }
  - 完成标记：{ type: 'done', sessionId }
  - 错误分片：{ type: 'error', error }
- 前端读取：
  - fetch + ReadableStream 逐块解析（POST 接口）
  - 或新增 GET 接口并使用 EventSource（SSE 标准方案）

WebSocket 接口说明
- 已移除 `/conversation/ws`（过期的 AI 对话 Socket.io 流式网关）。
- AI 流式能力使用 SSE（`GET /conversation/chat/stream`）或非流式 REST（`POST /conversation/chat`）。

Checkpoint 历史接口
 - GET `/conversation/checkpoints/:threadId`
  - 入参：`threadId`（等同于对话组ID `conversationGroupId`）；`limit?`（默认50）
  - 出参：`{ threadId, items: [{ checkpointId, ts, metadata? }] }`
- GET `/conversation/checkpoints/:threadId/:checkpointId`
  - 入参：`threadId`（对话组ID）、`checkpointId`
  - 出参：
    - `checkpoint`：`{ id, ts }`
    - `metadata?`：记录的附加元信息
    - `writes`：`[{ taskId, channel, value }]`（原始写入）
    - `history`：从 writes 推导的片段 `[{ role, content, channel? }]`
  - 说明：`history` 为便于前端直读的片段集合；完整上下文可调用 `/conversation/sessions/:sessionId/history`。

Summary 接口
- GET `/conversation/groups/:groupId/summaries`
  - 入参：`groupId`（对话组ID）；`limit?`（默认100）
  - 出参：`{ groupId, items: [{ sessionId, roundNumber, summaryContent, createdAt }] }`
  - 说明：聚合该分组下所有会话的阶段性摘要（默认每 20 轮一条），倒序返回；前端可用于时间线或概览面板。

注释规范
- 源码中对外接口/类型/守卫函数均使用 JSDoc 描述用途与关键校验点
- 对因 ESLint 类型服务误判的成员访问，使用行内精准关闭注释：
  // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access
  仅对具体行生效，避免影响其他规则与文件

#problems_and_diagnostics
诊断清单（Checklist）
- [x] 类型与守卫集中到 types 目录并加注释
- [x] controller/service 引用统一使用路径别名（@ / @core）
- [x] 流式响应按 SSE 语法输出 data: {json}\n\n

常见问题与处理
- [warning] 前端无法用 EventSource 消费 POST 流
  - 处理：使用 fetch 读取 ReadableStream，或新增 GET 流式接口
- [info] ESLint 对成员访问误判为 error typed value
  - 处理：保持 tsc 通过后，针对具体行添加精准关闭注释
- [info] 相对路径在目录迁移后断裂
  - 处理：统一使用路径别名 @ / @core 引入

# 关键词与文件对照（Keywords ↔ Files）
- 中文关键词 ↔ 英文关键词 ↔ 文件名
- 对话组列表 ↔ conversation-group list ↔ controllers/conversation-group.controller.ts
- 最新消息 ↔ latest message ↔ controllers/conversation-group.controller.ts
- 分页 ↔ pagination ↔ controllers/conversation-group.controller.ts
- 对话历史 ↔ conversation history ↔ controllers/conversation-group.controller.ts
- 对话服务 ↔ conversation service ↔ services/conversation.service.ts
- 类型与守卫 ↔ types and guards ↔ types/conversation.types.ts
- IM 消息历史 ↔ im message history ↔ controllers/im.controller.ts
- IM 新消息探测 ↔ im has-new probe ↔ controllers/im.controller.ts

# 关键词到文件函数哈希映射（Keywords -> Function Hash）
- ConversationGroupController.listGroups -> 98f1c2a7
- ConversationGroupController.listGroupHistory -> 3b7d5e21
- ConversationService.chat -> 5c2ea110
- ConversationService.chatStream -> a8d44c6f
- ConversationService.getSessionHistory -> 1d9b7e02
- ImMessageService.getMessages -> im_msg_get_001
- ImMessageService.hasNew -> im_msg_has_new_002

备注
- 本文件仅用于目录与规范说明，便于 IDE 与开发者快速了解模块结构；不参与构建。
